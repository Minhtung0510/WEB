@model MotoBikeStore.Models.Order
@{ Layout="~/Views/Shared/_Layout.cshtml"; ViewData["Title"]="Thanh toán"; }

<div class="container py-5">
  <h3 class="mb-4"><i class="fas fa-credit-card me-2"></i>Thanh toán đơn hàng</h3>
  
  <div class="row g-4">
    <!-- Customer Info Form -->
    <div class="col-md-7">
      <div class="card">
        <div class="card-header bg-white">
          <h5 class="mb-0">Thông tin khách hàng</h5>
        </div>
        <div class="card-body">
          <form method="post" id="checkoutForm">
            <div asp-validation-summary="All" class="text-danger mb-3"></div>
            
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Họ tên <span class="text-danger">*</span></label>
                <input asp-for="CustomerName" class="form-control" required />
              </div>
              
              <div class="col-md-6">
                <label class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                <input asp-for="Phone" class="form-control" required />
              </div>
              
              <div class="col-md-6">
                <label class="form-label">Email</label>
                <input asp-for="Email" type="email" class="form-control" />
              </div>
              
              <div class="col-12">
                <label class="form-label">Địa chỉ giao hàng <span class="text-danger">*</span></label>
                <textarea asp-for="Address" class="form-control" rows="2" required></textarea>
              </div>
              
              <div class="col-12">
                <label class="form-label">Ghi chú</label>
                <textarea asp-for="Notes" class="form-control" rows="2" 
                          placeholder="Ghi chú thêm về đơn hàng (nếu có)"></textarea>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Order Summary -->
    <div class="col-md-5">
      <div class="card mb-3">
        <div class="card-header bg-white">
          <h5 class="mb-0">Đơn hàng của bạn</h5>
        </div>
        <div class="card-body">
          @foreach(var p in (List<MotoBikeStore.Models.Product>)ViewBag.Products)
          {
            <div class="d-flex mb-3 pb-3 border-bottom">
              <img src="@p.ImageUrl" style="width:60px;height:60px;object-fit:contain" class="me-3" />
              <div class="flex-grow-1">
                <h6 class="mb-1">@p.Name</h6>
                <small class="text-muted">Số lượng: 1</small>
              </div>
              <div class="text-end">
                <strong>@p.Price.ToString("N0")₫</strong>
              </div>
            </div>
          }
          
          <div class="border-top pt-3">
            <div class="d-flex justify-content-between mb-2">
              <span>Tạm tính:</span>
              <strong id="subtotal">@((decimal)ViewBag.Subtotal).ToString("N0")₫</strong>
            </div>
            
            <div class="d-flex justify-content-between mb-2">
              <span>Phí vận chuyển:</span>
              <strong id="shipping">@(((decimal)ViewBag.Subtotal >= 5000000) ? "Miễn phí" : "150,000₫")</strong>
            </div>
            
            <div class="d-flex justify-content-between mb-3 text-success" id="discountRow" style="display:none !important">
              <span>Giảm giá:</span>
              <strong id="discount">0₫</strong>
            </div>
            
            <div class="d-flex justify-content-between fs-5">
              <strong>Tổng cộng:</strong>
              <strong class="text-danger" id="total">
                @(((decimal)ViewBag.Subtotal >= 5000000 ? (decimal)ViewBag.Subtotal : (decimal)ViewBag.Subtotal + 150000).ToString("N0"))₫
              </strong>
            </div>
          </div>
        </div>
      </div>

      <!-- Coupon Code -->
      <div class="card mb-3">
        <div class="card-body">
          <h6 class="mb-3"><i class="fas fa-ticket-alt me-2"></i>Mã giảm giá</h6>
          <div class="input-group">
            <input type="text" class="form-control" id="couponCode" name="couponCode" 
                   placeholder="Nhập mã giảm giá">
            <button class="btn btn-outline-primary" type="button" onclick="applyCoupon()">
              Áp dụng
            </button>
          </div>
          <div id="couponMessage" class="mt-2"></div>
          @if(TempData["CouponError"] != null)
          {
            <div class="alert alert-danger mt-2 mb-0">@TempData["CouponError"]</div>
          }
        </div>
      </div>

      <!-- Submit Button -->
      <button type="submit" form="checkoutForm" class="btn btn-success w-100 btn-lg">
        <i class="fas fa-check-circle me-2"></i>Xác nhận đặt hàng
      </button>
      
      <div class="text-center mt-3">
        <small class="text-muted">
          <i class="fas fa-lock me-1"></i>Thanh toán an toàn và bảo mật
        </small>
      </div>
    </div>
  </div>
</div>

<script>
let subtotal = @ViewBag.Subtotal;
let shippingFee = subtotal >= 5000000 ? 0 : 150000;
let discountAmount = 0;

function applyCoupon() {
  const code = document.getElementById('couponCode').value.trim();
  const messageEl = document.getElementById('couponMessage');
  
  if(!code) {
    messageEl.innerHTML = '<div class="alert alert-warning mb-0">Vui lòng nhập mã giảm giá</div>';
    return;
  }
  
  fetch('/Coupons/Validate', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ code: code, orderAmount: subtotal })
  })
  .then(res => res.json())
  .then(data => {
    if(data.valid) {
      discountAmount = data.discount;
      updateTotal();
      messageEl.innerHTML = `<div class="alert alert-success mb-0"><i class="fas fa-check-circle me-2"></i>${data.message}</div>`;
      document.getElementById('checkoutForm').innerHTML += `<input type="hidden" name="couponCode" value="${code}">`;
    } else {
      messageEl.innerHTML = `<div class="alert alert-danger mb-0"><i class="fas fa-times-circle me-2"></i>${data.message}</div>`;
    }
  })
  .catch(err => {
    messageEl.innerHTML = '<div class="alert alert-danger mb-0">Lỗi khi kiểm tra mã giảm giá</div>';
  });
}

function updateTotal() {
  const total = subtotal + shippingFee - discountAmount;
  document.getElementById('total').textContent = total.toLocaleString('vi-VN') + '₫';
  
  if(discountAmount > 0) {
    document.getElementById('discount').textContent = '-' + discountAmount.toLocaleString('vi-VN') + '₫';
    document.getElementById('discountRow').style.display = 'flex';
  }
}
</script>